var ProjectFirmaMaps={};ProjectFirmaMaps.Map=function(n,t){var e=this,l,r,i,f,h;this.MapDivId=n.MapDivID;var a=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{}),v=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{}),y=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{}),c=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}",{}),s={Aerial:a,Street:v,Terrain:y},u={"Street Labels":c},o;for(t==="Hybrid"?(o=new L.LayerGroup,t="Aerial",c.addTo(o)):(Sitka.Methods.isUndefinedNullOrEmpty(t)||s[t]==null)&&(t="Terrain"),l={scrollWheelZoom:!1,layers:[s[t]],attributionControl:!1,fullscreenControl:n.AllowFullScreen?{pseudoFullscreen:!0}:!1},this.map=L.map(this.MapDivId,l),o!=null&&o.addTo(this.map),i=0;i<n.ExternalMapLayers.length;++i)r=n.ExternalMapLayers[i],r.IsTiledMapService&&this.addTiledLayerFromAGOL(r,u);for(this.vectorLayers=[],i=0;i<n.ExternalMapLayers.length;++i)r=n.ExternalMapLayers[i],r.IsTiledMapService||this.addVectorLayerFromAGOL(r,u,n.RequestSupportUrl);for(i=0;i<n.Layers.length;++i){f=n.Layers[i];switch(f.LayerType){case"Vector":this.addVectorLayer(f,u);break;case"Wms":this.addWmsLayer(f,u);break;default:console.error("Invalid LayerType "+f.LayerType+" not added to map layers.")}}if(this.addLayersToMapLayersControl(s,u),h=jQuery(".modal"),!Sitka.Methods.isUndefinedNullOrEmpty(h))h.on("shown.bs.modal",function(){e.map.invalidateSize();e.setMapBounds(n)});if(!n.DisablePopups)this.map.on("click",function(n){e.getFeatureInfo(n)});e.setMapBounds(n)};ProjectFirmaMaps.Map.prototype.addTiledLayerFromAGOL=function(n,t){var i=L.esri.tiledMapLayer({url:n.LayerUrl});t[n.DisplayName]=i;n.LayerIsOnByDefault&&i.addTo(this.map)};ProjectFirmaMaps.Map.prototype.addVectorLayerFromAGOL=function(n,t,i){var r=L.esri.featureLayer({url:n.LayerUrl});n.FeatureNameField&&r.bindPopup(function(t){var r=this.getLatLng();return t.feature.properties[n.FeatureNameField]?L.Util.template("<strong>"+n.DisplayName+": <\/strong> {"+n.FeatureNameField+"}<br ><strong>Location: <\/strong>"+r.lat.toFixed(4)+", "+r.lng.toFixed(4),t.feature.properties):L.Util.template('<div class="alert alert-danger">The configured Feature Name was not found. <a href="'+i+'" target="_blank">Request Support<\/a> to notify Administrators<\/div>',t.feature.properties)});t[n.DisplayName]=r;n.LayerIsOnByDefault&&r.addTo(this.map)};ProjectFirmaMaps.Map.prototype.addVectorLayer=function(n,t){var r=this,i=new L.LayerGroup,u=L.geoJson(n.GeoJsonFeatureCollection,{pointToLayer:function(t,i){var r=t.properties.FeatureColor==null?n.LayerColor:t.properties.FeatureColor;return L.marker(i,{icon:L.MakiMarkers.icon({icon:"marker",color:r,size:"s"})})},style:function(t){var i=_.includes(["Polygon","MultiPolygon"],t.geometry.type);return{color:t.properties.FeatureColor==null?n.LayerColor:t.properties.FeatureColor,weight:t.properties.FeatureWeight==null?2:t.properties.FeatureWeight,fill:t.properties.FillPolygon==null?i:t.properties.FillPolygon,fillOpacity:t.properties.FillOpacity==null?.2:t.properties.FillOpacity}},onEachFeature:function(n,t){r.bindPopupToFeature(t,n);r.bindHoverToFeature(t,n)}}).addTo(i);n.LayerInitialVisibility===1&&i.addTo(this.map);t[n.LayerName]=i;this.vectorLayers.push(u)};ProjectFirmaMaps.Map.prototype.addWmsLayer=function(n,t){var i=new L.LayerGroup,u=L.Util.extend(this.wmsParams,{layers:n.MapServerLayerName}),r=L.tileLayer.wms(n.MapServerUrl,u).addTo(i);n.LayerInitialVisibility===1&&i.addTo(this.map);r.on("click",function(n){self.getFeatureInfo(n)});t[n.LayerName]=i;this.vectorLayers.push(r)};ProjectFirmaMaps.Map.prototype.wmsParams={service:"WMS",transparent:!0,version:"1.1.1",format:"image/png",info_format:"application/json",tiled:!0};ProjectFirmaMaps.Map.prototype.wfsParams={service:"WFS",version:"2.0",request:"GetFeature",outputFormat:"application/json",SrsName:"EPSG:4326"};ProjectFirmaMaps.Map.prototype.addLayersToMapLayersControl=function(n,t){this.layerControl=L.control.layers(n,t);this.layerControl.addTo(this.map)};ProjectFirmaMaps.Map.prototype.setMapBounds=function(n){this.map.fitBounds([[n.BoundingBox.Northeast.Latitude,n.BoundingBox.Northeast.Longitude],[n.BoundingBox.Southwest.Latitude,n.BoundingBox.Southwest.Longitude]])};ProjectFirmaMaps.Map.prototype.bindPopupToFeature=function(n,t){var i=this;if(!Sitka.Methods.isUndefinedNullOrEmpty(t.properties.PopupUrl)){n.bindPopup("Loading...");n.on("click",function(r){i.map.setView(r.target.getLatLng());jQuery.get(t.properties.PopupUrl).done(function(t){n.bindPopup(t).openPopup({})})})}};ProjectFirmaMaps.Map.prototype.bindHoverToFeature=function(n,t){if(!Sitka.Methods.isUndefinedNullOrEmpty(t.properties["Hover Name"])){n.bindTooltip(t.properties["Hover Name"],{direction:"auto",sticky:"true"});var i=n.options.fillOpacity;n.on("mouseover",function(){n.setStyle({fillOpacity:Math.min(i+.4,1)})});n.on("mouseout",function(){n.setStyle({fillOpacity:i})})}return n};ProjectFirmaMaps.Map.prototype.assignClickEventHandler=function(n){for(var r,i=this,t=0;t<this.vectorLayers.length;++t){r=this.vectorLayers[t];r.on("click",function(t){n(i,t)})}this.map.on("click",function(t){n(i,t)})};ProjectFirmaMaps.Map.prototype.removeClickEventHandler=function(){for(var t,n=0;n<this.vectorLayers.length;++n)t=this.vectorLayers[n],t.off("click");this.map.off("click")};ProjectFirmaMaps.Map.prototype.formatLayerProperty=function(n,t){return Sitka.Methods.isUndefinedNullOrEmpty(t)&&(t="&nbsp"),"<span><strong>"+n+":<\/strong> "+t+"<\/span><\/br>"};ProjectFirmaMaps.Map.prototype.removeLayerFromMap=function(n){Sitka.Methods.isUndefinedNullOrEmpty(n)||this.map.removeLayer(n)};ProjectFirmaMaps.Map.prototype.addLayerToLayerControl=function(n,t){this.layerControl.addOverlay(n,t)};ProjectFirmaMaps.Map.prototype.disableUserInteraction=function(){this.map.dragging.disable();this.map.touchZoom.disable();this.map.doubleClickZoom.disable();this.map.scrollWheelZoom.disable();this.map.boxZoom.disable();this.map.keyboard.disable();this.map.attributionControl=!1;this.map.tap&&this.map.tap.disable();document.getElementById(this.MapDivId).style.cursor="default";jQuery(".leaflet-control-zoom").css("visibility","hidden");jQuery(".leaflet-control-layers").css("visibility","hidden");this.removeClickEventHandler()};ProjectFirmaMaps.Map.prototype.blockMapImpl=function(){this.map.dragging.disable();this.map.scrollWheelZoom.disable();jQuery("#"+this.MapDivId).block({message:"<span style='font-weight: bold; font-size: 14px; margin: 0 2px'>Location Not Specified<\/span>",css:{border:"none",cursor:"default"},overlayCSS:{backgroundColor:"#D3D3D3",cursor:"default"},baseZ:999})};ProjectFirmaMaps.Map.prototype.blockMap=function(){var t=this,n;this.blockMapImpl();n=jQuery(".modal");n.on("shown.bs.modal",function(){t.blockMapImpl()})};ProjectFirmaMaps.Map.prototype.unblockMap=function(){this.map.dragging.enable();jQuery("#"+this.MapDivId).unblock()};ProjectFirmaMaps.Map.prototype.getFeatureInfo=function(n){var t=n.latlng,i=this,r=this.vectorLayers.filter(function(n){return n.hasOwnProperty("wmsParams")&&i.map.hasLayer(n)}),u=this.vectorLayers.filter(function(n){return!n.hasOwnProperty("wmsParams")&&i.map.hasLayer(n)});r.length>0?this.popupForWMSAndVectorLayers(r,u,t):this.popupForVectorLayers(u,t)};ProjectFirmaMaps.Map.prototype.popupForVectorLayers=function(n,t){for(var u,f,e,o,i=[],r=0;r<n.length;++r)u=n[r],f=this.getVectorLayerInfoHtmlForPopup(u,t),i.push(f);e=L.Util.formatNum(t.lat,4);o=L.Util.formatNum(t.lng,4);i.push({label:"Location",link:e+", "+o});this.map.setView(t);this.map.openPopup(L.popup({maxWidth:200}).setLatLng(t).setContent(this.htmlPopupContents(i)).openOn(this.map))};ProjectFirmaMaps.Map.prototype.htmlPopupContents=function(n){var i=this,r=this.removeDuplicatesFromArray(n,"label"),t="<div>";return _.forEach(r,function(n){n.label!=null&&(t+=i.formatLayerProperty(n.label,n.link))}),t+="<\/div>"};ProjectFirmaMaps.Map.prototype.getVectorLayerInfoHtmlForPopup=function(n,t){for(var i,u=null,f=null,e=leafletPip.pointInLayer(t,n,!0),o=_(e).map(function(n){return _.keys(n.feature.properties)}).flatten().uniq().map(function(n){return{key:n,values:_(e).map(function(t){return t.feature.properties[n]}).filter().value()}}).value(),r=0;r<o.length;r++)i=o[r],i.key!=="Hover Name"&&(u=i.values.length>1?i.key+"s":i.key,f=i.values.join(", "));return{label:u,link:f}};ProjectFirmaMaps.Map.prototype.popupForWMSAndVectorLayers=function(n,t,i){var r=this,o=this.map.latLngToContainerPoint(i,this.map.getZoom()),s=this.map.getSize(),f={service:"WMS",version:"1.1.1",request:"GetFeatureInfo",layers:n[0].wmsParams.layers,styles:"",srs:"EPSG:4326",bbox:this.map.getBounds().toBBoxString(),height:s.y,width:s.x,query_layers:n[0].wmsParams.layers,info_format:"application/json"},e,u,h,c;for(f.x=o.x,f.y=o.y,e=[],u=0;u<n.length;++u)h=n[u],c=h._url+L.Util.getParamString(f,null,!0),e.push(jQuery.when(jQuery.ajax({url:c})).then(function(n){return r.formatGeospatialAreaResponse(n)}));this.carryOutPromises(e).then(function(n){for(var e,o,s,h,u=[],f=0;f<t.length;++f)e=t[f],o=r.getVectorLayerInfoHtmlForPopup(e,i),u.push(o);_.forEach(n,function(n){u.push(n)});s=L.Util.formatNum(i.lat,4);h=L.Util.formatNum(i.lng,4);u.push({label:"Location",link:s+", "+h});r.map.setView(i);r.map.openPopup(L.popup({maxWidth:200}).setLatLng(i).setContent(r.htmlPopupContents(u)).openOn(r.map))},function(){console.log("error getting wms feature info")})};ProjectFirmaMaps.Map.prototype.carryOutPromises=function(n){var t=new jQuery.Deferred;return $.when.apply(jQuery,n).then(function(){t.resolve(Array.prototype.slice.call(arguments))},function(){t.fail(Array.prototype.slice.call(arguments))}),t};ProjectFirmaMaps.Map.prototype.removeDuplicatesFromArray=function(n,t){var u=[],r={};for(var i in n)r[n[i][t]]=n[i];for(i in r)u.push(r[i]);return u};ProjectFirmaMaps.Map.prototype.formatGeospatialAreaResponse=function(n){var t=null,i;return n.features.length>0&&(i="<a title='' href='/GeospatialArea/Detail/"+n.features[0].properties.GeospatialAreaID+"'>"+n.features[0].properties.GeospatialAreaName+"<\/a>",t={label:n.features[0].properties.GeospatialAreaTypeName,link:i}),t};