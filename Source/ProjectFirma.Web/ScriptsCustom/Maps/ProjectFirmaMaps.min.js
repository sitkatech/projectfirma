var ProjectFirmaMaps={};ProjectFirmaMaps.Map=function(n,t){var i=this,l,u,r,e,h;this.MapDivId=n.MapDivID;i.mapLayers=[];i.externalFeatureLayers=n.ExternalMapLayerSimples.filter(function(n){return!n.IsTiledMapService});var a=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{}),v=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",{}),y=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{}),c=new L.TileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}",{}),s={Aerial:a,Street:v,Terrain:y},f={"Street Labels":c},o;for(t==="Hybrid"?(o=new L.LayerGroup,t="Aerial",c.addTo(o)):(Sitka.Methods.isUndefinedNullOrEmpty(t)||s[t]==null)&&(t="Terrain"),o!=null&&o.addTo(i.map),l={scrollWheelZoom:!1,layers:[s[t]],attributionControl:!1,fullscreenControl:n.AllowFullScreen?{pseudoFullscreen:!0}:!1},ProjectFirmaMaps.Map.prototype.wmsParams={service:"WMS",transparent:!0,version:"1.1.1",format:"image/png",info_format:"application/json",tiled:!0},ProjectFirmaMaps.Map.prototype.wfsParams={service:"WFS",version:"2.0",request:"GetFeature",outputFormat:"application/json",SrsName:"EPSG:4326"},i.map=L.map(i.MapDivId,l),r=0;r<n.ExternalMapLayerSimples.length;++r)u=n.ExternalMapLayerSimples[r],u.IsTiledMapService&&i.addTiledLayerFromAGOL(u,f);for(r=0;r<n.ExternalMapLayerSimples.length;++r)u=n.ExternalMapLayerSimples[r],u.IsTiledMapService||i.addVectorLayerFromAGOL(u,f);for(r=0;r<n.Layers.length;++r){e=n.Layers[r];switch(e.LayerType){case"Vector":i.addVectorLayer(e,f);break;case"Wms":i.addWmsLayer(e,f);break;default:console.error("Invalid LayerType "+e.LayerType+" not added to map layers.")}}if(i.addLayersToMapLayersControl(s,f),h=jQuery(".modal"),!Sitka.Methods.isUndefinedNullOrEmpty(h))h.on("shown.bs.modal",function(){i.map.invalidateSize();i.setMapBounds(n)});if(!n.DisablePopups)i.map.on("click",function(n){i.getFeatureInfo(n)});i.setMapBounds(n)};ProjectFirmaMaps.Map.prototype.addLayersToMapLayersControl=function(n,t){this.layerControl=L.control.layers(n,t);this.layerControl.addTo(this.map)};ProjectFirmaMaps.Map.prototype.setMapBounds=function(n){this.map.fitBounds([[n.BoundingBox.Northeast.Latitude,n.BoundingBox.Northeast.Longitude],[n.BoundingBox.Southwest.Latitude,n.BoundingBox.Southwest.Longitude]])};ProjectFirmaMaps.Map.prototype.removeLayerFromMap=function(n){Sitka.Methods.isUndefinedNullOrEmpty(n)||this.map.removeLayer(n)};ProjectFirmaMaps.Map.prototype.addLayerToLayerControl=function(n,t){this.layerControl.addOverlay(n,t)};ProjectFirmaMaps.Map.prototype.disableUserInteraction=function(){this.map.dragging.disable();this.map.touchZoom.disable();this.map.doubleClickZoom.disable();this.map.scrollWheelZoom.disable();this.map.boxZoom.disable();this.map.keyboard.disable();this.map.attributionControl=!1;this.map.tap&&this.map.tap.disable();document.getElementById(this.MapDivId).style.cursor="default";jQuery(".leaflet-control-zoom").css("visibility","hidden");jQuery(".leaflet-control-layers").css("visibility","hidden");this.removeClickEventHandler()};ProjectFirmaMaps.Map.prototype.blockMapImpl=function(){this.map.dragging.disable();this.map.scrollWheelZoom.disable();jQuery("#"+this.MapDivId).block({message:"<span style='font-weight: bold; font-size: 14px; margin: 0 2px'>Location Not Specified<\/span>",css:{border:"none",cursor:"default"},overlayCSS:{backgroundColor:"#D3D3D3",cursor:"default"},baseZ:999})};ProjectFirmaMaps.Map.prototype.blockMap=function(){var t=this,n;this.blockMapImpl();n=jQuery(".modal");n.on("shown.bs.modal",function(){t.blockMapImpl()})};ProjectFirmaMaps.Map.prototype.unblockMap=function(){this.map.dragging.enable();jQuery("#"+this.MapDivId).unblock()};ProjectFirmaMaps.Map.prototype.addWmsLayer=function(n,t){var i=new L.LayerGroup,u=L.Util.extend(this.wmsParams,{layers:n.MapServerLayerName}),r=L.tileLayer.wms(n.MapServerUrl,u).addTo(i);n.LayerInitialVisibility===1&&i.addTo(this.map);r.on("click",function(n){firmaMap.getFeatureInfo(n)});t[n.LayerName]=i;this.mapLayers.push(r)};ProjectFirmaMaps.Map.prototype.addVectorLayer=function(n,t){var i=this,r=new L.LayerGroup,u=L.geoJson(n.GeoJsonFeatureCollection,{pointToLayer:function(t,i){var r=t.properties.FeatureColor==null?n.LayerColor:t.properties.FeatureColor;return L.marker(i,{icon:L.MakiMarkers.icon({icon:"marker",color:r,size:"s"})})},style:function(t){var i=_.includes(["Polygon","MultiPolygon"],t.geometry.type);return{color:t.properties.FeatureColor==null?n.LayerColor:t.properties.FeatureColor,weight:t.properties.FeatureWeight==null?2:t.properties.FeatureWeight,fill:t.properties.FillPolygon==null?i:t.properties.FillPolygon,fillOpacity:t.properties.FillOpacity==null?.2:t.properties.FillOpacity}},onEachFeature:function(n,t){i.bindPopupToFeature(t,n);i.bindHoverToFeature(t,n)}}).addTo(r);n.LayerInitialVisibility===1&&r.addTo(i.map);t[n.LayerName]=r;i.mapLayers.push(u)};ProjectFirmaMaps.Map.prototype.addTiledLayerFromAGOL=function(n,t){var i=L.esri.tiledMapLayer({url:n.LayerUrl});t[n.DisplayName]=i;n.LayerIsOnByDefault&&i.addTo(this.map)};ProjectFirmaMaps.Map.prototype.addVectorLayerFromAGOL=function(n,t){var i=L.esri.featureLayer({url:n.LayerUrl,useCors:!0,interactive:!1});t[n.DisplayName]=i;n.LayerIsOnByDefault&&i.addTo(this.map)};ProjectFirmaMaps.Map.prototype.bindHoverToFeature=function(n,t){if(!Sitka.Methods.isUndefinedNullOrEmpty(t.properties["Hover Name"])){n.bindTooltip(t.properties["Hover Name"],{direction:"auto",sticky:"true"});var i=n.options.fillOpacity;n.on("mouseover",function(){n.setStyle({fillOpacity:Math.min(i+.4,1)})});n.on("mouseout",function(){n.setStyle({fillOpacity:i})})}return n};ProjectFirmaMaps.Map.prototype.bindPopupToFeature=function(n,t){var i=this;if(!Sitka.Methods.isUndefinedNullOrEmpty(t.properties.PopupUrl)){n.bindPopup("Loading...");n.on("click",function(r){var u=r.target.getLatLng();i.map.setView(u);jQuery.get(t.properties.PopupUrl).done(function(t){n.bindPopup(t).openPopup()})})}};ProjectFirmaMaps.Map.prototype.assignClickEventHandler=function(n){for(var r,t=this,i=0;i<t.mapLayers.length;++i){r=t.mapLayers[i];r.on("click",function(i){n(t,i)})}t.map.on("click",function(i){n(t,i)})};ProjectFirmaMaps.Map.prototype.removeClickEventHandler=function(){for(var t,n=0;n<this.mapLayers.length;++n)t=this.mapLayers[n],t.off("click");this.map.off("click")};ProjectFirmaMaps.Map.prototype.formatLayerProperty=function(n,t){return Sitka.Methods.isUndefinedNullOrEmpty(t)&&(t="&nbsp"),"<span><strong>"+n+":<\/strong> "+t+"<\/span><\/br>"};ProjectFirmaMaps.Map.prototype.getFeatureInfo=function(n){var i=n.latlng,t=this,r=t.mapLayers.filter(function(n){return n.hasOwnProperty("wmsParams")&&t.map.hasLayer(n)}),u=t.mapLayers.filter(function(n){return!n.hasOwnProperty("wmsParams")&&t.map.hasLayer(n)}),f=t.externalFeatureLayers;r.length>0?t.popupForWMSAndVectorLayers(r,u,f,i):t.callPopupForVectorLayers(u,f,i)};ProjectFirmaMaps.Map.prototype.popupForWMSAndVectorLayers=function(n,t,i,r){var u=this,l=this.map.latLngToContainerPoint(r,u.map.getZoom()),a=u.map.getSize(),f,e,o,v,s,h,c;for(geospatialAreaWMSParams={service:"WMS",version:"1.1.1",request:"GetFeatureInfo",styles:"",srs:"EPSG:4326",bbox:u.map.getBounds().toBBoxString(),height:a.y,width:a.x,info_format:"application/json"},geospatialAreaWMSParams.x=l.x,geospatialAreaWMSParams.y=l.y,f=[],e=0;e<n.length;++e)o=n[e],geospatialAreaWMSParams.layers=o.wmsParams.layers,geospatialAreaWMSParams.query_layers=o.wmsParams.layers,v=o._url+L.Util.getParamString(geospatialAreaWMSParams,null,!0),f.push(jQuery.when(jQuery.ajax({url:v})).then(function(n){return u.formatGeospatialAreaResponse(n)}));if(i.length>0)for(s=0;s<i.length;s++)h=i[s],c=L.esri.query({url:h.LayerUrl}),c.intersects(r),u.runEsriFeatureLayerQueryThenResolvePromises(h,c,f,t,r);else u.carryOutPromises(f).then(function(n){u.openPopupIncludingAsyncContent(n,t,r)},function(){console.log("error getting wms feature info")})};ProjectFirmaMaps.Map.prototype.callPopupForVectorLayers=function(n,t,i){var f=this,e=[],r,u,o;if(t.length>0)for(r=0;r<t.length;r++)u=t[r],o=L.esri.query({url:u.LayerUrl}),f.runEsriFeatureLayerQueryThenCallPopupForVectorLayers(u,o,i,n,e);else f.popupForVectorLayers(n,e,i)};ProjectFirmaMaps.Map.prototype.runEsriFeatureLayerQueryThenResolvePromises=function(n,t,i,r,u){var f=this,e;t.run(function(t,o){e=f.formatExternalFeatureLayerResponse(t,n,o);f.carryOutPromises(i).then(function(n){f.openPopupIncludingAsyncContent(n,r,u,e)},function(){console.log("error getting wms feature info")})})};ProjectFirmaMaps.Map.prototype.runEsriFeatureLayerQueryThenCallPopupForVectorLayers=function(n,t,i,r,u){var f=this,e;t.intersects(i);t.run(function(t,o){e=f.formatExternalFeatureLayerResponse(t,n,o);u.push(e);f.popupForVectorLayers(r,u,i)})};ProjectFirmaMaps.Map.prototype.popupForVectorLayers=function(n,t,i){for(var u,f,e,o,r=0;r<n.length;++r)u=n[r],f=this.formatVectorLayerInfo(u,i),t.push(f);e=L.Util.formatNum(i.lat,4);o=L.Util.formatNum(i.lng,4);t.push({label:"Location",link:e+", "+o});this.map.setView(i);this.map.openPopup(L.popup({maxWidth:200}).setLatLng(i).setContent(this.htmlPopupContents(t)).openOn(this.map))};ProjectFirmaMaps.Map.prototype.carryOutPromises=function(n){var t=new jQuery.Deferred;return $.when.apply(jQuery,n).then(function(){t.resolve(Array.prototype.slice.call(arguments))},function(){t.fail(Array.prototype.slice.call(arguments))}),t};ProjectFirmaMaps.Map.prototype.openPopupIncludingAsyncContent=function(n,t,i,r){for(var o,s,h,c,u=this,f=[],e=0;e<t.length;++e)o=t[e],s=u.formatVectorLayerInfo(o,i),f.push(s);_.forEach(n,function(n){n&&f.push(n)});r&&f.push(r);h=L.Util.formatNum(i.lat,4);c=L.Util.formatNum(i.lng,4);f.push({label:"Location",link:h+", "+c});u.map.setView(i);u.map.openPopup(L.popup({maxWidth:200}).setLatLng(i).setContent(u.htmlPopupContents(f)).openOn(u.map))};ProjectFirmaMaps.Map.prototype.formatGeospatialAreaResponse=function(n){var t=null,i;return n.features.length>0&&(i="<a title='' href='/GeospatialArea/Detail/"+n.features[0].properties.GeospatialAreaID+"'>"+n.features[0].properties.GeospatialAreaShortName+"<\/a>",t={label:n.features[0].properties.GeospatialAreaTypeName,link:i}),t};ProjectFirmaMaps.Map.prototype.formatVectorLayerInfo=function(n,t){for(var i,u=null,f=null,e=leafletPip.pointInLayer(t,n,!0),o=_(e).map(function(n){return _.keys(n.feature.properties)}).flatten().uniq().map(function(n){return{key:n,values:_(e).map(function(t){return t.feature.properties[n]}).filter().value()}}).value(),r=0;r<o.length;r++)i=o[r],i.key!=="Hover Name"&&(u=i.values.length>1?i.key+"s":i.key,f=i.values.join(", "));return{label:u,link:f}};ProjectFirmaMaps.Map.prototype.formatExternalFeatureLayerResponse=function(n,t,i){var r,u,f,e;if(n)return console.log(n),null;for(r="",u=0;u<i.features.length;u++)f=i.features[u],f.properties.hasOwnProperty(t.FeatureNameField)&&(r+=f.properties[t.FeatureNameField]);return e=null,r!=""&&(e={label:t.DisplayName,link:r}),e};ProjectFirmaMaps.Map.prototype.htmlPopupContents=function(n){var t=this,r=t.removeDuplicatesFromArray(n,"label"),i="<div>";return _.forEach(r,function(n){n.label!=null&&(i+=t.formatLayerProperty(n.label,n.link))}),i+="<\/div>"};ProjectFirmaMaps.Map.prototype.removeDuplicatesFromArray=function(n,t){var u=[],r={};for(var i in n)r[n[i][t]]=n[i];for(i in r)u.push(r[i]);return u};